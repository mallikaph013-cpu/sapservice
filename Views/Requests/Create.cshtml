@model myapp.Models.ViewModels.CreateRequestViewModel
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "Create Service Request";
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">

        <!-- Manual Creation Form -->
        <div class="main-content-card mb-5">
            <div class="text-center mb-4">
                <h2>Create New Service Request</h2>
                <p class="text-light">Please fill in the details of your request below.</p>
            </div>

            <form id="create-form" asp-action="Create">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-4"></div>

                <h5>Requester Information</h5>
                <p class="text-light small mb-3">Your details are automatically filled from your profile.</p>
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="form-group"><label asp-for="RequesterName" class="form-label"></label><input asp-for="RequesterName" class="form-control" readonly /></div></div>
                    <div class="col-md-3"><div class="form-group"><label asp-for="Department" class="form-label"></label><input asp-for="Department" class="form-control" readonly /></div></div>
                    <div class="col-md-2"><div class="form-group"><label asp-for="Section" class="form-label"></label><input asp-for="Section" class="form-control" readonly /></div></div>
                    <div class="col-md-3"><div class="form-group"><label asp-for="RequesterPlant" class="form-label"></label><input asp-for="RequesterPlant" class="form-control" readonly /></div></div>
                </div>

                <hr class="my-4">

                <h5>Request Details</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="RequestType" class="form-label"></label>
                            <select asp-for="RequestType" id="RequestType" class="form-select" asp-items="Html.GetEnumSelectList<myapp.Models.RequestType>()">
                                <option value="">-- Select Type --</option>
                            </select>
                            <span asp-validation-for="RequestType" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Plant" class="form-label"></label>
                            <select asp-for="Plant" class="form-select">
                                <option value="">-- Select Plant --</option>
                                <option value="6021">6021 (Device)</option>
                                <option value="6031">6031 (Assembly)</option>
                                <option value="6051">6051 (Injection)</option>
                                <option value="6081">6081 (IPO)</option>
                                <option value="6060">6060</option>
                            </select>
                            <span asp-validation-for="Plant" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="3" placeholder="Provide a detailed description of the request..."></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <partial name="_MaterialForms" model="Model" />

                <hr class="my-4">

                <h5>Approver</h5>
                <p class="text-light small mb-3">Select a request type to see the list of available approvers.</p>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="NextResponsibleUserId" class="form-label">Next Responsible User</label>
                            <select name="NextResponsibleUserId" id="NextResponsibleUserId" class="form-select" required>
                                <option value="">-- Please select a request type first --</option>
                            </select>
                        </div>
                    </div>
                </div>

                @if (SignInManager.IsSignedIn(User) && User.IsInRole("IT"))
                {
                    <hr class="my-4" />
                    <h5>IT Status Update</h5>
                     <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Status" class="form-label"></label>
                                <select asp-for="Status" class="form-select">
                                    <option value="Pending">Pending</option>
                                    <option value="Run Standard Cost">Run Standard Cost</option>
                                    <option value="Check and Confirm">Check and Confirm</option>
                                    <option value="Release">Release</option>
                                    <option value="Input Price">Input Price</option>
                                    <option value="Complete">Complete</option>
                                </select>
                            </div>
                        </div>
                    </div>
                }

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5">
                    <a asp-action="Index" class="btn btn-outline-secondary me-md-2">
                        <i class="fas fa-arrow-left me-1"></i> Back to List
                    </a>
                    <button type="submit" id="create-submit-button" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Submit Request
                    </button>
                </div>
            </form>
        </div>

        <!-- Excel Import Form -->
        <div class="main-content-card">
             <div class="text-center mb-4">
                <h2>Import from Excel</h2>
                <p class="text-light">Quickly add multiple requests by uploading a pre-filled Excel file.</p>
            </div>
            <form id="import-form" asp-action="Import" method="post" enctype="multipart/form-data">
                 <div class="mb-3">
                    <label for="excelFile" class="form-label">Select Excel File (.xlsx, .xls)</label>
                    <input class="form-control" type="file" id="excelFile" name="file" accept=".xlsx, .xls" required>
                </div>

                <input type="hidden" name="NextResponsibleUserId" id="importNextResponsibleUserId" />
                
                <div class="d-flex justify-content-center align-items-center mt-4">
                    <div class="input-group">
                        <a id="download-template-link" href="#" class="btn btn-outline-secondary disabled">
                            <i class="fas fa-download me-2"></i>Download Template
                        </a>
                        <button type="submit" id="import-submit-button" class="btn btn-success">
                            <i class="fas fa-file-excel me-2"></i>Import File
                        </button>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const requestTypeSelect = document.getElementById('RequestType');
            const materialFieldsContainer = document.getElementById('material-fields-container');
            const allMaterialFields = materialFieldsContainer.querySelectorAll('[data-types]');
            const bomContainer = document.getElementById('bom-fields-container');
            const routingContainer = document.getElementById('routing-fields-container');
            const nextResponsibleUserSelect = document.getElementById('NextResponsibleUserId');
            const importNextResponsibleUserIdInput = document.getElementById('importNextResponsibleUserId');
            const createForm = document.getElementById('create-form');
            const importForm = document.getElementById('import-form');
            const downloadLink = document.getElementById('download-template-link');
            const distributionChannelSelect = document.getElementById('DistributionChannel');
            const boiCodeContainer = document.getElementById('boi-code-container');

            const typeMapping = {
                '0': 'FG',
                '1': 'SM',
                '2': 'RM',
                '3': 'ToolingB',
                '4': 'ToolingBFG',
                '5': 'ToolingBPU',
                '6': 'BOM',
                '7': 'Routing',
                '8': 'AddStorage',
                '9': 'DistributionChanel',
                '10': 'IPO',
                '11': 'Passthrough',
                '12': 'CrossPlantPurchase'
            };

            function toggleBoiCode() {
                if (!distributionChannelSelect) return;
                const selectedChannel = distributionChannelSelect.value;
                // Show BOI Code field only if Distribution Channel is 'Indirect' (2) or 'Export' (3)
                if (selectedChannel === '2' || selectedChannel === '3') {
                    boiCodeContainer.style.display = 'block';
                } else {
                    boiCodeContainer.style.display = 'none';
                }
            }

            function toggleMaterialFields() {
                const selectedValue = requestTypeSelect.value;
                const selectedTypeName = typeMapping[selectedValue] || '';

                const showMaterialFields = selectedValue && selectedTypeName !== 'BOM' && selectedTypeName !== 'Routing';
                materialFieldsContainer.style.display = showMaterialFields ? 'block' : 'none';

                if (showMaterialFields) {
                    allMaterialFields.forEach(field => {
                        const parentCol = field.closest('.col-md-4, .col-md-6, .col-md-8, .col-md-12');
                        if (parentCol) {
                            const types = parentCol.dataset.types ? parentCol.dataset.types.split(',') : [];
                            if (types.includes(selectedTypeName)) {
                                parentCol.style.display = 'block';
                            } else {
                                parentCol.style.display = 'none';
                            }
                        }
                    });
                }

                bomContainer.style.display = selectedTypeName === 'BOM' ? 'block' : 'none';
                routingContainer.style.display = selectedTypeName === 'Routing' ? 'block' : 'none';
                
                // After toggling all fields, specifically check for BOI code visibility
                toggleBoiCode();
            }

            function fetchNextApprovers() {
                const requestTypeValue = requestTypeSelect.value;
                nextResponsibleUserSelect.innerHTML = '<option value="">-- Loading... --</option>';

                if (requestTypeValue) {
                    fetch(`/Requests/GetNextApprovers?requestType=${requestTypeValue}`)
                        .then(response => response.json())
                        .then(data => {
                            nextResponsibleUserSelect.innerHTML = '<option value="">-- Please select a responsible user --</option>';
                            if (data && data.length > 0) {
                                data.forEach(user => {
                                    const option = new Option(user.fullName, user.id);
                                    nextResponsibleUserSelect.add(option);
                                });
                            } else {
                                nextResponsibleUserSelect.innerHTML = '<option value="">-- No users found --</option>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching approvers:', error);
                            nextResponsibleUserSelect.innerHTML = '<option value="">-- Error loading data --</option>';
                        });
                } else {
                    nextResponsibleUserSelect.innerHTML = '<option value="">-- Please select a request type first --</option>';
                }
            }
            
            function updateDownloadLink() {
                const selectedValue = requestTypeSelect.value;
                if (selectedValue) {
                    downloadLink.href = `/Requests/DownloadTemplate?requestType=${selectedValue}`;
                    downloadLink.classList.remove('disabled');
                } else {
                    downloadLink.href = '#';
                    downloadLink.classList.add('disabled');
                }
            }

            function checkResponsibleUser(event) {
                if (nextResponsibleUserSelect.value === '') {
                    event.preventDefault(); // Stop form submission
                    Swal.fire({
                        title: 'Incomplete Information',
                        text: "Please select a 'Next Responsible User' before submitting.",
                        icon: 'warning',
                        confirmButtonColor: '#F97316' // Primary Orange
                    });
                }
            }

            // --- BOM & Routing Logic from Edit.cshtml ---
            function addBomItem(level) {
                const tbody = document.getElementById('bom-items-body');
                const index = tbody.getElementsByTagName('tr').length;
                const newRow = `
                    <tr>
                        <td><input type="text" name="Components[${index}].Level" class="form-control" value="${level}" readonly/></td>
                        <td><input type="text" name="Components[${index}].Item" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].ItemCat" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].ComponentNumber" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].Description" class="form-control" /></td>
                        <td><input type="number" name="Components[${index}].ItemQuantity" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].Unit" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].BomUsage" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].Plant" class="form-control" /></td>
                        <td><input type="text" name="Components[${index}].Sloc" class="form-control" /></td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-bom-item">Remove</button></td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', newRow);
            }
            
            document.getElementById('add-parent-item').addEventListener('click', () => addBomItem(1));
            document.getElementById('add-child-item').addEventListener('click', () => addBomItem(2));

            document.getElementById('bom-items-body').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-bom-item')) {
                    e.target.closest('tr').remove();
                }
            });

            document.getElementById('add-routing-item').addEventListener('click', function() {
                const tbody = document.getElementById('routing-items-body');
                const index = tbody.rows.length;
                const row = `
                    <tr>
                        <td><input class="form-control" type="text" name="Routings[${index}].Material"></td>
                        <td><input class="form-control" type="text" name="Routings[${index}].WorkCenter"></td>
                        <td><input class="form-control" type="text" name="Routings[${index}].Operation"></td>
                        <td><input class="form-control" type="number" name="Routings[${index}].BaseQty"></td>
                        <td><input class="form-control" type="text" name="Routings[${index}].Unit"></td>
                        <td><input class="form-control" type="number" step="0.01" name="Routings[${index}].DirectLaborCosts"></td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-routing-item">Remove</button></td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            document.getElementById('routing-items-body').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-routing-item')) {
                    e.target.closest('tr').remove();
                }
            });

            // Initial setup
            toggleMaterialFields();
            updateDownloadLink();
            fetchNextApprovers(); // Fetch approvers on page load if a type is already selected

            // Event Listeners
            requestTypeSelect.addEventListener('change', () => {
                toggleMaterialFields();
                fetchNextApprovers();
                updateDownloadLink();
            });

            if (distributionChannelSelect) {
                 distributionChannelSelect.addEventListener('change', toggleBoiCode);
            }

            nextResponsibleUserSelect.addEventListener('change', () => {
                 importNextResponsibleUserIdInput.value = nextResponsibleUserSelect.value;
            });
            createForm.addEventListener('submit', checkResponsibleUser);
            importForm.addEventListener('submit', checkResponsibleUser);
        });
    </script>
}
