@model myapp.Models.ViewModels.CreateRequestViewModel
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "Create Service Request";
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">

        <!-- Manual Creation Form -->
        <div class="main-content-card mb-5">
            <div class="text-center mb-4">
                <h2>Create New Service Request</h2>
                <p class="text-light">Please fill in the details of your request below.</p>
            </div>

            <form id="create-form" asp-action="Create">
                <div asp-validation-summary="All" class="text-danger mb-4"></div>

                <h5>Requester Information</h5>
                <p class="text-light small mb-3">Your details are automatically filled from your profile.</p>
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="form-group"><label asp-for="RequesterName" class="form-label"></label><input asp-for="RequesterName" class="form-control" readonly /></div></div>
                    <div class="col-md-3"><div class="form-group"><label asp-for="Department" class="form-label"></label><input asp-for="Department" class="form-control" readonly /></div></div>
                    <div class="col-md-2"><div class="form-group"><label asp-for="Section" class="form-label"></label><input asp-for="Section" class="form-control" readonly /></div></div>
                    <div class="col-md-3"><div class="form-group"><label asp-for="Plant" class="form-label"></label><input asp-for="Plant" class="form-control" readonly /></div></div>
                </div>

                <hr class="my-4">

                <h5>Request Details</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="RequestType" class="form-label"></label>
                            <select asp-for="RequestType" id="RequestType" class="form-select" asp-items="Html.GetEnumSelectList<myapp.Models.RequestType>()">
                                <option value="">-- Select Type --</option>
                            </select>
                            <span asp-validation-for="RequestType" class="text-danger"></span>
                        </div>
                    </div>
                    <div id="plant-fg-group" class="col-md-6" style="display: none;">
                        <div class="form-group">
                            <label asp-for="PlantFG" class="form-label"></label>
                            <select asp-for="PlantFG" class="form-select">
                                <option value="">-- Select Plant --</option>
                                <option value="6021">6021 (Device)</option>
                                <option value="6031">6031 (Assembly)</option>
                                <option value="6051">6051 (Injection)</option>
                                <option value="6081">6081 (IPO)</option>
                                <option value="6060">6060</option>
                            </select>
                            <span asp-validation-for="PlantFG" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="3" placeholder="Provide a detailed description of the request..."></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <partial name="_MaterialForms" model="Model" />

                <hr class="my-4">

                <h5>Approver</h5>
                <p class="text-light small mb-3">Select a request type to see the list of available approvers.</p>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="NextResponsibleUserId" class="form-label">Next Responsible User</label>
                            <select name="NextResponsibleUserId" id="NextResponsibleUserId" class="form-select" required>
                                <option value="">-- Please select a request type first --</option>
                            </select>
                        </div>
                    </div>
                </div>

                @if (SignInManager.IsSignedIn(User) && User.IsInRole("IT"))
                {
                    <hr class="my-4" />
                    <h5>IT Status Update</h5>
                     <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Status" class="form-label"></label>
                                <select asp-for="Status" class="form-select">
                                    <option value="Pending">Pending</option>
                                    <option value="Run Standard Cost">Run Standard Cost</option>
                                    <option value="Check and Confirm">Check and Confirm</option>
                                    <option value="Release">Release</option>
                                    <option value="Input Price">Input Price</option>
                                    <option value="Complete">Complete</option>
                                </select>
                            </div>
                        </div>
                    </div>
                }

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5">
                    <a asp-action="Index" class="btn btn-secondary me-md-2">Back to List</a>
                    <input type="submit" id="create-submit-button" value="Submit Request" class="btn btn-primary" />
                </div>
            </form>
        </div>

        <!-- Excel Import Form -->
        <div class="main-content-card">
             <div class="text-center mb-4">
                <h2>Import from Excel</h2>
                <p class="text-light">Quickly add multiple requests by uploading a pre-filled Excel file.</p>
            </div>
            <form id="import-form" asp-action="Import" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="excelFile" class="form-label">Select Excel File (.xlsx, .xls)</label>
                    <input class="form-control" type="file" id="excelFile" name="file" accept=".xlsx, .xls" required>
                </div>

                <input type="hidden" name="NextResponsibleUserId" id="importNextResponsibleUserId" />
                
                <div class="d-flex justify-content-center align-items-center mt-4">
                    <button type="submit" id="import-submit-button" class="btn btn-success me-3">Import File</button>
                    <a id="download-template-link" href="#" class="btn btn-outline-secondary disabled">Download Template</a>
                </div>
            </form>
        </div>

    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // (The existing JavaScript remains the same, no changes needed here for styling)
        // I am omitting the JS code here for brevity, but it is the same as the original file.
        document.addEventListener('DOMContentLoaded', function () {
            const requestTypeSelect = document.getElementById('RequestType');
            const downloadLink = document.getElementById('download-template-link');
            const fgFieldsContainer = document.getElementById('fg-fields-container');
            const smFieldsContainer = document.getElementById('sm-fields-container');
            const rmFieldsContainer = document.getElementById('rm-fields-container');
            const toolingbFieldsContainer = document.getElementById('toolingb-fields-container');
            const toolingbfgFieldsContainer = document.getElementById('toolingbfg-fields-container');
            const toolingbpuFieldsContainer = document.getElementById('toolingbpu-fields-container');
            const distributionchanelFieldsContainer = document.getElementById('distributionchanel-fields-container');
            const addstorageFieldsContainer = document.getElementById('addstorage-fields-container');
            const bomFieldsContainer = document.getElementById('bom-fields-container');
            const routingFieldsContainer = document.getElementById('routing-fields-container');
            const ipoFieldsContainer = document.getElementById('ipo-fields-container');
            const plantFgGroup = document.getElementById('plant-fg-group');
            const nextResponsibleUserSelect = document.getElementById('NextResponsibleUserId');
            const importNextResponsibleUserIdInput = document.getElementById('importNextResponsibleUserId');
            const importForm = document.getElementById('import-form');
            const createForm = document.getElementById('create-form');

            const fgEnumValue = '0'; 
            const smEnumValue = '1'; 
            const rmEnumValue = '2';
            const toolingBEnumValue = '3';
            const toolingBFGEnumValue = '4';
            const toolingBPUEnumValue = '5';
            const bomEnumValue = '6';
            const routingEnumValue = '7';
            const addStorageEnumValue = '8';
            const distributionChanelEnumValue = '9';
            const ipoEnumValue = '10';

            function checkResponsibleUser(event) {
                if (nextResponsibleUserSelect.value === '') {
                    event.preventDefault(); // Stop form submission
                    Swal.fire({
                        title: 'Incomplete Information',
                        text: "Please select a 'Next Responsible User' before submitting.",
                        icon: 'warning',
                        confirmButtonColor: '#F97316' // Primary Orange
                    });
                }
            }

            function toggleMaterialFields() {
                const selectedValue = requestTypeSelect.value;

                // Hide all containers
                fgFieldsContainer.style.display = 'none';
                smFieldsContainer.style.display = 'none';
                rmFieldsContainer.style.display = 'none';
                toolingbFieldsContainer.style.display = 'none';
                toolingbfgFieldsContainer.style.display = 'none';
                toolingbpuFieldsContainer.style.display = 'none';
                distributionchanelFieldsContainer.style.display = 'none';
                addstorageFieldsContainer.style.display = 'none';
                bomFieldsContainer.style.display = 'none';
                routingFieldsContainer.style.display = 'none';
                ipoFieldsContainer.style.display = 'none';
                plantFgGroup.style.display = 'none';

                // Show the relevant container
                if (selectedValue === fgEnumValue) {
                    fgFieldsContainer.style.display = 'block';
                    plantFgGroup.style.display = 'block';
                } else if (selectedValue === smEnumValue) {
                    smFieldsContainer.style.display = 'block';
                } else if (selectedValue === rmEnumValue) {
                    rmFieldsContainer.style.display = 'block';
                } else if (selectedValue === toolingBEnumValue) {
                    toolingbFieldsContainer.style.display = 'block';
                } else if (selectedValue === toolingBFGEnumValue) {
                    toolingbfgFieldsContainer.style.display = 'block';
                } else if (selectedValue === toolingBPUEnumValue) {
                    toolingbpuFieldsContainer.style.display = 'block';
                } else if (selectedValue === distributionChanelEnumValue) {
                    distributionchanelFieldsContainer.style.display = 'block';
                } else if (selectedValue === addStorageEnumValue) {
                    addstorageFieldsContainer.style.display = 'block';
                } else if (selectedValue === bomEnumValue) {
                    bomFieldsContainer.style.display = 'block';
                } else if (selectedValue === routingEnumValue) {
                    routingFieldsContainer.style.display = 'block';
                } else if (selectedValue === ipoEnumValue) {
                    ipoFieldsContainer.style.display = 'block';
                }
            }
            
            function fetchNextApprovers() {
                const requestTypeValue = requestTypeSelect.value;
                nextResponsibleUserSelect.innerHTML = '<option value="">-- Loading... --</option>';

                if (requestTypeValue) {
                    fetch(`/Requests/GetNextApprovers?requestType=${requestTypeValue}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            nextResponsibleUserSelect.innerHTML = '<option value="">-- Please select a responsible user --</option>';
                            if (data && data.length > 0) {
                                data.forEach(user => {
                                    const option = new Option(user.fullName, user.id);
                                    nextResponsibleUserSelect.add(option);
                                });
                            } else {
                                nextResponsibleUserSelect.innerHTML = '<option value="">-- No users found for the specified rule --</option>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching approvers:', error);
                            nextResponsibleUserSelect.innerHTML = '<option value="">-- Error loading data --</option>';
                        });
                } else {
                    nextResponsibleUserSelect.innerHTML = '<option value="">-- Please select a request type first --</option>';
                }
            }

            function updateDownloadLink() {
                const selectedValue = requestTypeSelect.value;
                if (selectedValue) {
                    downloadLink.href = `/Requests/DownloadTemplate?requestType=${selectedValue}`;
                    downloadLink.classList.remove('disabled');
                } else {
                    downloadLink.href = '#';
                    downloadLink.classList.add('disabled');
                }
            }

            const bomTableBody = document.getElementById('bom-items-body');
            const addParentBtn = document.getElementById('add-parent-item');
            const addChildBtn = document.getElementById('add-child-item');

            function findParentRow(childRow) {
                let previousSibling = childRow.previousElementSibling;
                while(previousSibling) {
                    if (previousSibling.classList.contains('bom-level-1')) {
                        return previousSibling;
                    }
                    previousSibling = previousSibling.previousElementSibling;
                }
                return null;
            }

            function reIndexBomTable() {
                let parentCounter = 0;
                let lastParentRow = null;
                const childCounters = new Map();

                Array.from(bomTableBody.children).forEach((row, index) => {
                    row.querySelectorAll('input, select').forEach(input => {
                        if (input.name) {
                            input.name = input.name.replace(/Components\\[\d+\\]/, `Components[${index}]`);
                        }
                    });

                    const level = row.classList.contains('bom-level-1') ? 1 : 2;
                    let itemValue = '';

                    if (level === 1) {
                        parentCounter++;
                        itemValue = parentCounter.toString();
                        lastParentRow = row;
                        row.dataset.parentIndex = parentCounter;
                        childCounters.set(parentCounter, 0);
                    } else if (level === 2) {
                        const parentRow = findParentRow(row);
                        if (parentRow) {
                            const parentIndex = parseInt(parentRow.dataset.parentIndex);
                            let childCounter = childCounters.get(parentIndex) || 0;
                            childCounter++;
                            itemValue = (childCounter * 10).toString().padStart(3, '0');
                            childCounters.set(parentIndex, childCounter);
                            row.dataset.parentIndex = parentIndex;

                            // Sync with parent
                            const parentBomUsage = parentRow.querySelector('.bom-usage-field').value;
                            const parentPlant = parentRow.querySelector('.plant-field').value;
                            row.querySelector('.bom-usage-field').value = parentBomUsage;
                            row.querySelector('.plant-field').value = parentPlant;
                        }
                    }
                    row.querySelector('.item-field').value = itemValue;
                });
            }
            
            function createBomRow(level) {
                const index = bomTableBody.children.length;
                const newRow = document.createElement('tr');
                newRow.classList.add(`bom-level-${level}`);

                newRow.innerHTML = `
                    <td>
                        <input type="hidden" name="Components[${index}].Level" value="${level}" />
                        ${level}
                    </td>
                    <td><input type="text" name="Components[${index}].Item" class="form-control item-field" readonly /></td>
                    <td><input type="text" name="Components[${index}].ItemCat" class="form-control item-cat-field" value="L" /></td>
                    <td><input type="text" name="Components[${index}].ComponentNumber" class="form-control" /></td>
                    <td><input type="text" name="Components[${index}].Description" class="form-control" /></td>
                    <td><input type="number" step="any" name="Components[${index}].ItemQuantity" class="form-control" /></td>
                    <td><input type="text" name="Components[${index}].Unit" class="form-control" /></td>
                    <td><input type="text" name="Components[${index}].BomUsage" class="form-control bom-usage-field" /></td>
                    <td><input type="text" name="Components[${index}].Plant" class="form-control plant-field" /></td>
                    <td><input type="text" name="Components[${index}].Sloc" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-bom-item">X</button></td>
                `;
                
                const bomUsageInput = newRow.querySelector('.bom-usage-field');
                const plantInput = newRow.querySelector('.plant-field');
                const itemCatInput = newRow.querySelector('.item-cat-field');

                if (level === 1) { // Parent Row
                    itemCatInput.readOnly = true;
                    bomUsageInput.readOnly = false; // Editable
                    plantInput.readOnly = false;    // Editable
                } else { // Component Row
                    itemCatInput.readOnly = false;
                    bomUsageInput.readOnly = true; // Readonly
                    plantInput.readOnly = true;    // Readonly
                }
                return newRow;
            }

            addParentBtn.addEventListener('click', () => {
                const newRow = createBomRow(1);
                bomTableBody.appendChild(newRow);
                reIndexBomTable();
            });

            addChildBtn.addEventListener('click', () => {
                const lastRow = bomTableBody.querySelector('tr:last-child');
                if (!lastRow) {
                    alert('Please add a Parent (Level 1) item first.');
                    return;
                }

                const parentRowForNewChild = lastRow.classList.contains('bom-level-1') ? lastRow : findParentRow(lastRow);

                if (!parentRowForNewChild) {
                    alert('Could not find a parent for this component. Please add a Parent (Lvl 1) first.');
                    return;
                }
                
                const newRow = createBomRow(2);

                const allRows = Array.from(bomTableBody.children);
                const parentIndex = parentRowForNewChild.dataset.parentIndex;
                let lastRowInGroup = parentRowForNewChild;
                 for (let i = allRows.indexOf(parentRowForNewChild) + 1; i < allRows.length; i++) {
                    if (allRows[i].dataset.parentIndex === parentIndex) {
                        lastRowInGroup = allRows[i];
                    } else {
                        break;
                    }
                }
                lastRowInGroup.insertAdjacentElement('afterend', newRow);

                reIndexBomTable();
            });

            bomTableBody.addEventListener('click', e => {
                if (e.target.classList.contains('remove-bom-item')) {
                    const rowToRemove = e.target.closest('tr');
                    const isParent = rowToRemove.classList.contains('bom-level-1');
                    
                    if (isParent) {
                        const parentIndex = rowToRemove.dataset.parentIndex;
                        const children = Array.from(bomTableBody.querySelectorAll(`.bom-level-2[data-parent-index='${parentIndex}']`));
                        children.forEach(child => child.remove());
                    }
                    rowToRemove.remove();
                    reIndexBomTable();
                }
            });

            bomTableBody.addEventListener('input', e => {
                const input = e.target;
                const row = input.closest('tr');

                if (row && row.classList.contains('bom-level-1')) {
                    const parentIndex = row.dataset.parentIndex;
                    const children = bomTableBody.querySelectorAll(`.bom-level-2[data-parent-index='${parentIndex}']`);

                    if (input.classList.contains('bom-usage-field')) {
                        children.forEach(child => {
                            child.querySelector('.bom-usage-field').value = input.value;
                        });
                    } else if (input.classList.contains('plant-field')) {
                        children.forEach(child => {
                            child.querySelector('.plant-field').value = input.value;
                        });
                    }
                }
            });

            const routingTableBody = document.getElementById('routing-items-body');
            const addRoutingBtn = document.getElementById('add-routing-item');

            function reIndexRoutingTable() {
                Array.from(routingTableBody.children).forEach((row, index) => {
                    row.querySelectorAll('input, select').forEach(input => {
                        if (input.name) {
                            input.name = input.name.replace(/Routings\\[\d+\\]/, `Routings[${index}]`);
                        }
                    });
                });
            }

            function createRoutingRow() {
                const index = routingTableBody.children.length;
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" name="Routings[${index}].Material" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].Description" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].WorkCenter" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].Operation" class="form-control" /></td>
                    <td><input type="number" step="any" name="Routings[${index}].BaseQty" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].Unit" class="form-control" /></td>
                    <td><input type="number" step="any" name="Routings[${index}].DirectLaborCosts" class="form-control" /></td>
                    <td><input type="number" step="any" name="Routings[${index}].DirectExpenses" class="form-control" /></td>
                    <td><input type="number" step="any" name="Routings[${index}].AllocationExpense" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].ProductionVersionCode" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].Version" class="form-control" /></td>
                    <td><input type="date" name="Routings[${index}].ValidFrom" class="form-control" /></td>
                    <td><input type="date" name="Routings[${index}].ValidTo" class="form-control" /></td>
                    <td><input type="number" step="any" name="Routings[${index}].MaximumLotSize" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].Group" class="form-control" /></td>
                    <td><input type="text" name="Routings[${index}].GroupCounter" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-routing-item">X</button></td>
                `;
                return newRow;
            }

            addRoutingBtn.addEventListener('click', () => {
                const newRow = createRoutingRow();
                routingTableBody.appendChild(newRow);
                reIndexRoutingTable();
            });

            routingTableBody.addEventListener('click', e => {
                if (e.target.classList.contains('remove-routing-item')) {
                    e.target.closest('tr').remove();
                    reIndexRoutingTable();
                }
            });

            toggleMaterialFields();
            updateDownloadLink(); 

            requestTypeSelect.addEventListener('change', () => {
                toggleMaterialFields();
                fetchNextApprovers();
                updateDownloadLink();
            });

            nextResponsibleUserSelect.addEventListener('change', () => {
                 importNextResponsibleUserIdInput.value = nextResponsibleUserSelect.value;
            });

            createForm.addEventListener('submit', checkResponsibleUser);
            importForm.addEventListener('submit', checkResponsibleUser);
        });
    </script>
}
